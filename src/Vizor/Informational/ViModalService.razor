@using System.Reflection;
<CascadingValue IsFixed="true" Value="this" Name="ViModalService">
	@ChildContent

	@modalFragment

	@if (modalId != null)
	{
		<a @key="@modal" id="@(modalId + "-toggle")" class="invisible" data-bs-toggle="modal" data-bs-target="@("#" + modalId)" aria-hidden="true" />
	}
</CascadingValue>

@code {

	private List<ViModalContext> modalDialogs = new();
	private List<string> modalsToShow = new();

	private TaskCompletionSource<ViModalBase>? modalRendered;

	private RenderFragment? modalFragment;
	private string? modalId;
	private ViModalBase? modal;

	[Inject]
	public IJSRuntime JSRuntime { get; set; } = default!;

	[Parameter, EditorRequired]
	public RenderFragment ChildContent { get; set; } = default!;

	public async Task<ModalResult> Show<TModal>() where TModal : ViModalBase
	{
		if (modal != null)
		{
			throw new InvalidOperationException("Only 1 modal can be active at any given time");
		}

		modalRendered = new TaskCompletionSource<ViModalBase>();

		modal = null;
		modalId = RazorExtensions.RandomId();
		modalFragment = builder =>
		{
			builder.OpenComponent<TModal>(0);
			builder.AddAttribute(1, "Id", modalId);
			builder.CloseComponent();
		};

		await InvokeAsync(StateHasChanged);

		modal = await modalRendered.Task;
		await JSRuntime.InvokeVoidAsync("viToggleModal", modalId + "-toggle");

		var result = await modal.Show();

		await JSRuntime.InvokeVoidAsync("viToggleModal", modalId + "-close");

		modal = null;
		modalId = null;
		modalFragment = null;
		await InvokeAsync(StateHasChanged);

		return result;
	}

	internal void SetModalRendered(ViModalBase modal)
	{
		this.modal = modal;

		//TODO: sanity checks
		modalRendered?.TrySetResult(modal);

		StateHasChanged();
	}
}